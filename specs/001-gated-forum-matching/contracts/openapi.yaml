openapi: 3.0.0
info:
  title: "三人行必有我師論壇 API"
  version: "1.0.0"
  description: "API for the Gated Forum and Matching platform."

paths:
  /api/auth/callback:
    get:
      summary: OIDC Callback
      description: Handles the OIDC provider's callback, exchanges the authorization code for tokens, and creates a user session.
      responses:
        '302':
          description: Redirects the user to the frontend application upon successful login.
        '400':
          description: Bad Request - Invalid request or state.
        '500':
          description: Internal Server Error.

  /api/users/me:
    get:
      summary: Get Current User Profile
      description: Fetches the profile of the currently authenticated user.
      responses:
        '200':
          description: Successful response.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MemberProfile'
        '401':
          description: Unauthorized.
    patch:
      summary: Update Current User Profile
      description: Updates the self-declared profile information for the currently authenticated user.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                nickname:
                  type: string
                gender:
                  type: string
                interests:
                  type: array
                  items:
                    type: string
      responses:
        '200':
          description: Profile updated successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MemberProfile'
        '400':
          description: Bad Request - Invalid input.
        '401':
          description: Unauthorized.

  /api/vc/verify/initiate:
    post:
      summary: Initiate VC Verification
      description: Starts the "Rank Card" VC verification process by generating a verification request URI.
      responses:
        '200':
          description: Verification initiated successfully.
          content:
            application/json:
              schema:
                type: object
                properties:
                  authUri:
                    type: string
                    format: uri
                  transactionId:
                    type: string
        '401':
          description: Unauthorized.
        '500':
          description: Error communicating with the VC verification service.

  /api/vc/verify/status:
    get:
      summary: Get VC Verification Status
      description: Polls for the status of a pending VC verification.
      parameters:
        - name: transactionId
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Returns the status of the verification.
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [PENDING, SUCCESS, FAILED, EXPIRED]
                  profile:
                    $ref: '#/components/schemas/MemberProfile'
        '401':
          description: Unauthorized.
        '404':
          description: Transaction not found.

  /api/forums:
    get:
      summary: List Available Forums
      description: Fetches a list of forums that the authenticated user is eligible to join based on their rank.
      responses:
        '200':
          description: A list of forums.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Forum'
        '401':
          description: Unauthorized.

  /api/forums/{forumId}/session:
    get:
      summary: Get Forum Chat Session
      description: Gets the necessary information to join a forum's chat room.
      parameters:
        - name: forumId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Chat session information.
          content:
            application/json:
              schema:
                type: object
                properties:
                  tlkChannelId:
                    type: string
        '401':
          description: Unauthorized.
        '403':
          description: Forbidden - User does not have the required rank.
        '404':
          description: Forum not found.

  /api/matching/daily:
    post:
      summary: Request Daily Match
      description: Initiates a request for a random daily 1-on-1 chat session.
      responses:
        '200':
          description: Match found and private chat session created.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PrivateChatSession'
        '204':
          description: No match found at the moment.
        '401':
          description: Unauthorized.
        '403':
          description: Forbidden - Only for verified members.

components:
  schemas:
    MemberProfile:
      type: object
      properties:
        id:
          type: string
          format: uuid
        status:
          type: string
          enum: [GENERAL, VERIFIED]
        nickname:
          type: string
        gender:
          type: string
        interests:
          type: array
          items:
            type: string
        linkedVcDid:
          type: string
        derivedRank:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Forum:
      type: object
      properties:
        id:
          type: string
          format: uuid
        requiredRank:
          type: string
        description:
          type: string
        tlkChannelId:
          type: string

    PrivateChatSession:
      type: object
      properties:
        id:
          type: string
          format: uuid
        tlkChannelId:
          type: string
        expiresAt:
          type: string
          format: date-time
